<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto IoT - Tempo Real</title>
    <link rel="stylesheet" href="css/dashboards.css">

    <!-- script do google charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>
</head>

<body onload="atualizacaoPeriodica()">
    <!--header inicio-->

    <div class="header">
        <div class="container">
            <h1 class="titulo"><span class="highlight">Projeto</span></h1>
            <div class="usuario">
                <h3>Olá, <b id="b_usuario"></b></h3>
            </div>
            <div class="nav">
                <ul>
                    <li><a href="#" class="highlight" onclick="logoff()">Sair</a></li>

                </ul>
            </div>
        </div>
    </div>
    <!--header fim-->

    <div class="dashboard">
        <div class="container">

            <div id="chart_div" style="width: 400px; height: 120px;"></div>
        </div>

    </div>
    </div>



</body>


<script>
    var Valores = 0
    let usuario;
    iduser = sessionStorage.id_usuario_meuapp
    console.log(iduser)
    verificar_autenticacao();

    // só mexer se quiser alterar o tempo de atualização
    // ou se souber o que está fazendo!
    function atualizacaoPeriodica() {
        obterdadosporusuario(iduser);
        setTimeout(atualizacaoPeriodica, 3000);
    }



    function obterdadosporusuario(iduser) {
        //aguardar();
        fetch(`/leituras/tempo-real/${iduser}`)
            .then(resposta => {

                console.log(resposta)
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {

                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        // aqui, após registro. use os nomes 
                        // dos atributos que vem no JSON 
                        var dados = {
                            dadoSensor: resposta.dadoSensor,
                        }
                        valores = dados.dadoSensor
                        console.log(dados.dadoSensor)
                        drawChart()

                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do caminhao p/ gráfico: ${error.message}`);
            });
    }

    google.charts.load('current', { 'packages': ['gauge'] });
    google.charts.setOnLoadCallback(drawChart);
    function drawChart() {
        var data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['Lumens', 0],
        ]);

        var options = {
            width: 700, height: 320,
            redFrom: 90, redTo: 100,
            yellowFrom: 75, yellowTo: 90,
            minorTicks: 5
        };

        var chart = new google.visualization.Gauge(document.getElementById('chart_div'));

        data.setValue(0, 1, valores);
        console.log(valores)
        chart.draw(data, options);
    }

    function sendData() {
        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:9001/api/sendData', false);
        http.send(null);
    }

    // Descomente abaixo se quiser inserir dados a cada X segundos  
    setInterval(function () {
        sendData();
    }, 3000);

</script>